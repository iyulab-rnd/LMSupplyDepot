# .github/workflows/release.yml
name: Build and Release

on:
  push:
    tags:
      - 'hostapp_v*'  # v1.0.0, v2.1.3 ë“±ì˜ íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ›’ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ”¨ Build and Publish
      run: |
        dotnet publish "src/LMSupplyDepots.HostApp/" `
          -c Release `
          -o "output/host-app" `
          --self-contained true `
          -r win-x64 `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true
    
    - name: ğŸ“‹ Get version from tag
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: powershell
      
    - name: ğŸ“¦ Create ZIP archive
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $zipFile = "LMSupplyDepots.HostApp-v$version-win-x64.zip"
        Compress-Archive -Path "output/host-app/*" -DestinationPath $zipFile -Force
        echo "ZIP_FILE=$zipFile" >> $env:GITHUB_OUTPUT
      shell: powershell
      id: create_zip
      
    - name: ğŸ“„ Generate Release Notes
      id: release_notes
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $notes = @"
        ## ğŸ‰ LMSupplyDepots HostApp v$version
        
        ### ğŸ“¦ ë‹¤ìš´ë¡œë“œ
        - **Windows x64**: LMSupplyDepots.HostApp-v$version-win-x64.zip (Self-contained)
        
        ### ğŸš€ ì„¤ì¹˜ ë°©ë²•
        1. ZIP íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì••ì¶•ì„ í•´ì œí•©ë‹ˆë‹¤
        2. \`LMSupplyDepots.HostApp.exe\`ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
        
        ### ğŸ”§ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
        - Windows 10/11 (x64)
        - .NET Runtime ì„¤ì¹˜ ë¶ˆí•„ìš” (ìì²´ í¬í•¨ ë°°í¬)
        
        ### ğŸ“‹ ì´ë²ˆ ë¦´ë¦¬ìŠ¤ì˜ ë³€ê²½ì‚¬í•­
        - ìë™ ìƒì„±ëœ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤
        - ìµœì‹  ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤
        "@
        
        # ë©€í‹°ë¼ì¸ ì¶œë ¥ì„ ìœ„í•œ ì²˜ë¦¬
        $notes | Out-File -FilePath release_notes.txt -Encoding utf8
        echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_OUTPUT
        Get-Content release_notes.txt | ForEach-Object { echo $_ >> $env:GITHUB_OUTPUT }
        echo "EOF" >> $env:GITHUB_OUTPUT
      shell: powershell
      
    - name: ğŸ¯ Create GitHub Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: LMSupplyDepots HostApp v${{ steps.get_version.outputs.VERSION }}
        body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
        
    - name: ğŸ“¤ Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ steps.create_zip.outputs.ZIP_FILE }}
        asset_name: ${{ steps.create_zip.outputs.ZIP_FILE }}
        asset_content_type: application/zip
        
    - name: ğŸŠ Success Notification
      run: |
        echo "ğŸ‰ Release v${{ steps.get_version.outputs.VERSION }} ë°°í¬ ì™„ë£Œ!"
        echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"
