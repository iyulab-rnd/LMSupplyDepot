# .github/workflows/release.yml
name: Build and Release

on:
  push:
    tags:
      - 'hostapp_v*'  # hostapp_v0.1.0 등

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: 🛒 Checkout code
      uses: actions/checkout@v4
      
    - name: 🔧 Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: 🔍 Debug workspace structure
      run: |
        echo "=== Current working directory ==="
        pwd
        echo ""
        echo "=== Root directory contents ==="
        Get-ChildItem -Name
        echo ""
        echo "=== Looking for .csproj files ==="
        Get-ChildItem -Recurse -Name "*.csproj"
        echo ""
        echo "=== Checking if src exists ==="
        Test-Path "src"
        echo ""
        echo "=== Checking HostApp specifically ==="
        Test-Path "src/LMSupplyDepots.HostApp"
        Test-Path "src/LMSupplyDepots.HostApp/LMSupplyDepots.HostApp.csproj"
        echo ""
        echo "=== All directories in src ==="
        if (Test-Path "src") {
          Get-ChildItem "src" -Directory -Name
        }
      shell: powershell
        
    - name: 📦 Restore dependencies
      run: dotnet restore src/
      
    - name: 🔨 Build and Publish (Alternative approach)
      run: |
        # 솔루션 파일을 통해 빌드하는 방법
        if (Test-Path "src/LMSupplyDepots.sln") {
          echo "Using solution file approach"
          dotnet publish src/LMSupplyDepots.sln `
            --project src/LMSupplyDepots.HostApp `
            -c Release `
            -o output/host-app `
            --self-contained true `
            -r win-x64 `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true
        } else {
          echo "Trying direct project path"
          dotnet publish src/LMSupplyDepots.HostApp/LMSupplyDepots.HostApp.csproj `
            -c Release `
            -o output/host-app `
            --self-contained true `
            -r win-x64 `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true
        }
      shell: powershell
    
    - name: 📋 Get version from tag
      id: version
      run: |
        $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
        if ($tag -match '^hostapp_v(.+)$') {
          $version = $matches[1]
        } elseif ($tag -match '^v(.+)$') {
          $version = $matches[1]
        } else {
          $version = $tag
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "Version: $version, Tag: $tag"
      shell: powershell
      
    - name: 📦 Create ZIP archive
      id: zip
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $zipFile = "LMSupplyDepots.HostApp-v$version-win-x64.zip"
        Compress-Archive -Path "output/host-app/*" -DestinationPath $zipFile -Force
        echo "ZIP_FILE=$zipFile" >> $env:GITHUB_OUTPUT
      shell: powershell
      
    - name: 📄 Generate Release Notes
      id: notes
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $notes = @"
        ## 🎉 LMSupplyDepots HostApp v$version
        
        ### 📦 다운로드
        - **Windows x64**: LMSupplyDepots.HostApp-v$version-win-x64.zip (Self-contained)
        
        ### 🚀 설치 방법
        1. ZIP 파일을 다운로드하고 압축을 해제합니다
        2. \`LMSupplyDepots.HostApp.exe\`를 실행합니다
        
        ### 🔧 시스템 요구사항
        - Windows 10/11 (x64)
        - .NET Runtime 설치 불필요 (자체 포함 배포)
        
        ### 📋 이번 릴리스의 변경사항
        - 자동 생성된 릴리스입니다
        - 최신 코드 변경사항이 포함되어 있습니다
        "@
        
        # 멀티라인 출력을 위한 처리
        $notes | Out-File -FilePath release_notes.txt -Encoding utf8
        echo "RELEASE_NOTES<<EOF" >> $env:GITHUB_OUTPUT
        Get-Content release_notes.txt | ForEach-Object { echo $_ >> $env:GITHUB_OUTPUT }
        echo "EOF" >> $env:GITHUB_OUTPUT
      shell: powershell
      
    - name: 🎯 Create GitHub Release
      uses: actions/create-release@v1
      id: release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.TAG }}
        release_name: LMSupplyDepots HostApp v${{ steps.version.outputs.VERSION }}
        body: ${{ steps.notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
        
    - name: 📤 Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.release.outputs.upload_url }}
        asset_path: ./${{ steps.zip.outputs.ZIP_FILE }}
        asset_name: ${{ steps.zip.outputs.ZIP_FILE }}
        asset_content_type: application/zip
        
    - name: 🎊 Success Notification
      run: |
        echo "🎉 Release v${{ steps.version.outputs.VERSION }} 배포 완료!"
        echo "🔗 Release URL: ${{ steps.release.outputs.html_url }}"
